<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Breathing Animation Fix Test</title>
    <style>
      :root {
        --md-sys-color-primary: #006a6b;
        --md-sys-color-primary-container: #6ff7f8;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: #f5f5f5;
        font-family: Arial, sans-serif;
      }

      .test-container {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 400px;
      }

      .breathing-circle {
        width: 160px;
        height: 160px;
        border: 4px solid var(--md-sys-color-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--md-sys-color-primary-container);
        position: relative;
        box-shadow: 0 0 20px rgba(0, 106, 107, 0.3);
        margin: 0 auto 20px;
        /* CRITICAL: Force hardware acceleration and prevent animation pausing */
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
        animation-play-state: running !important;
        /* Make element "interactive" to prevent Chrome from pausing animations */
        cursor: pointer;
        user-select: none;
      }

      @keyframes breatheIn {
        0% {
          transform: translateZ(0) scale(1);
          box-shadow: 0 0 20px rgba(0, 106, 107, 0.3);
        }
        100% {
          transform: translateZ(0) scale(1.3);
          box-shadow: 0 0 40px rgba(0, 106, 107, 0.5);
        }
      }

      @keyframes breatheOut {
        0% {
          transform: translateZ(0) scale(1.3);
          box-shadow: 0 0 40px rgba(0, 106, 107, 0.5);
        }
        100% {
          transform: translateZ(0) scale(0.8);
          box-shadow: 0 0 10px rgba(0, 106, 107, 0.2);
        }
      }

      @keyframes breatheHold {
        0% {
          transform: translateZ(0) scale(1);
          box-shadow: 0 0 20px rgba(0, 106, 107, 0.3);
        }
        100% {
          transform: translateZ(0) scale(1.1);
          box-shadow: 0 0 30px rgba(0, 106, 107, 0.4);
        }
      }

      .breathing-circle.animate-inhale {
        animation: breatheIn 4s cubic-bezier(0.4, 0, 0.6, 1) forwards !important;
      }

      .breathing-circle.animate-exhale {
        animation: breatheOut 4s cubic-bezier(0.4, 0, 0.6, 1) forwards !important;
      }

      .breathing-circle.animate-hold {
        animation: breatheHold 4s cubic-bezier(0.4, 0, 0.6, 1) forwards !important;
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        background: var(--md-sys-color-primary);
        color: white;
        cursor: pointer;
        font-size: 12px;
      }

      button:hover {
        opacity: 0.9;
      }

      .status {
        margin-top: 20px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
      }

      .breathing-text {
        font-size: 18px;
        margin: 10px 0;
        min-height: 25px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h2>Breathing Animation Fix Test</h2>
      <div class="breathing-circle" id="circle"></div>
      <div class="breathing-text" id="text">Ready</div>

      <div class="controls">
        <button onclick="startCycle()">Start Breathing Cycle</button>
        <button onclick="stopCycle()">Stop</button>
        <button onclick="testInhale()">Test Inhale</button>
        <button onclick="testExhale()">Test Exhale</button>
        <button onclick="reset()">Reset</button>
      </div>

      <div class="status" id="status">
        Click "Start Breathing Cycle" to test the fix...
      </div>
    </div>

    <script>
      const circle = document.getElementById("circle");
      const text = document.getElementById("text");
      const status = document.getElementById("status");
      let cycleInterval = null;
      let currentPhase = 0;

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        status.innerHTML += `[${timestamp}] ${message}<br>`;
        status.scrollTop = status.scrollHeight;
        console.log(message);
      }

      function reset() {
        circle.className = "breathing-circle";
        text.textContent = "Ready";
        if (cycleInterval) {
          clearInterval(cycleInterval);
          cycleInterval = null;
        }
        log("Reset");
      }

      function forceAnimationStart() {
        // CRITICAL FIX: Force browser to recognize element as interactive
        circle.style.pointerEvents = "auto";
        circle.style.cursor = "pointer";

        // Force hardware acceleration
        circle.style.transform = "translateZ(0)";
        circle.style.willChange = "transform, box-shadow";

        // Force a tiny movement to "wake up" the animation engine
        circle.style.transform = "translateZ(0) scale(1.001)";
        circle.offsetHeight; // Force reflow
        circle.style.transform = "translateZ(0)";

        log("Forced animation start");
      }

      function animatePhase(phase) {
        // Remove existing animation classes
        circle.classList.remove(
          "animate-inhale",
          "animate-exhale",
          "animate-hold"
        );

        // Force reflow
        circle.offsetHeight;

        // Apply new animation
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            switch (phase) {
              case "inhale":
                circle.classList.add("animate-inhale");
                text.textContent = "Breathe in...";
                break;
              case "exhale":
                circle.classList.add("animate-exhale");
                text.textContent = "Breathe out...";
                break;
              case "hold":
                circle.classList.add("animate-hold");
                text.textContent = "Hold...";
                break;
            }
            log(`Animated: ${phase}`);
          });
        });
      }

      function testInhale() {
        reset();
        forceAnimationStart();
        setTimeout(() => animatePhase("inhale"), 100);
      }

      function testExhale() {
        reset();
        forceAnimationStart();
        setTimeout(() => animatePhase("exhale"), 100);
      }

      function startCycle() {
        reset();
        forceAnimationStart();

        const phases = ["inhale", "hold", "exhale", "hold"];
        currentPhase = 0;

        function nextPhase() {
          if (cycleInterval) {
            animatePhase(phases[currentPhase]);
            currentPhase = (currentPhase + 1) % phases.length;
          }
        }

        // Start immediately
        nextPhase();

        // Continue cycle
        cycleInterval = setInterval(nextPhase, 4500);
        log("Started breathing cycle");
      }

      function stopCycle() {
        if (cycleInterval) {
          clearInterval(cycleInterval);
          cycleInterval = null;
          log("Stopped breathing cycle");
        }
        reset();
      }

      // Initialize
      forceAnimationStart();
      log("Initialized with animation fixes");
    </script>
  </body>
</html>
